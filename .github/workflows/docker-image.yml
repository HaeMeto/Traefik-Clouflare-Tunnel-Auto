name: Build and Push to Docker Hub

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write   # needed to create GitHub Releases
  packages: read

jobs:
  build-and-push:
    name: Build and Push Docker image
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # === Python setup & deps ===
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies (requirements.txt if present)
        if: hashFiles('requirements.txt') != ''
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests (if pytest available)
        run: |
          if python -c "import importlib; importlib.import_module('pytest')" 2>/dev/null; then
            pytest -q
          else
            echo "pytest not installed; skipping tests"
          fi

      # === Determine if current tag is the latest semver ===
      - name: Determine if this tag is latest
        id: semver
        shell: bash
        run: |
          is_latest=false
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            current="${GITHUB_REF_NAME}"
            if [[ "$current" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              latest="$(git tag -l | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1 || true)"
              if [[ "$current" == "$latest" ]]; then
                is_latest=true
              fi
            fi
          fi
          echo "is_latest=$is_latest" >> "$GITHUB_OUTPUT"

      # === Docker buildx for multi-arch ===
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/traefik-cloudflare-tunnel-auto
          tags: |
            type=semver,pattern={{version}},prefix=v
            type=semver,pattern={{major}}.{{minor}},prefix=v
            type=semver,pattern={{major}},prefix=v
            type=ref,event=branch
            type=sha,format=short
          flavor: |
            latest=${{ steps.semver.outputs.is_latest }}
          labels: |
            org.opencontainers.image.version_is_latest=${{ steps.semver.outputs.is_latest }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # === Compose release notes body (only on tag) ===
      - name: Compose release notes
        id: compose_release
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        env:
          IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/traefik-cloudflare-tunnel-auto
          TAGS: ${{ steps.meta.outputs.tags }}
          IS_LATEST: ${{ steps.semver.outputs.is_latest }}
        run: |
          first_semver_tag="$(echo "$TAGS" | grep -E '^[^ ]+:([0-9]+\.[0-9]+\.[0-9]+)$' | head -n1 | cut -d':' -f2)"
          if [[ -z "$first_semver_tag" ]]; then
            first_semver_tag="$(echo "$TAGS" | head -n1 | cut -d':' -f2)"
          fi
          latest_note="false"
          if [[ "$IS_LATEST" == "true" ]]; then latest_note="true"; fi

          {
            echo "## Docker Images"
            echo ""
            echo "The following tags were pushed for this release:"
            echo ""
            echo '```'
            echo "$TAGS" | sed 's/^/ - /'
            echo '```'
            echo ""
            echo "**Quickstart:**"
            echo ""
            echo '```bash'
            echo "docker pull $IMAGE:${first_semver_tag}"
            echo "docker run --rm $IMAGE:${first_semver_tag} --help"
            echo '```'
            echo ""
            echo "**Latest?** \`$latest_note\`"
            echo ""
            echo "> Built for \`linux/amd64\` and \`linux/arm64\`"
            echo "> Label: \`org.opencontainers.image.version_is_latest=$latest_note\`"
          } > body.md

          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          cat body.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # === Create GitHub Release with autogenerated notes + Docker info ===
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          body: ${{ steps.compose_release.outputs.body }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
